name: Python Client Release

on:
  push:
    branches:
      - main
    paths:
      - "clients/python/**"
      - "!clients/python/README.md"
      - "!clients/python/DOCUMENTATION.md"
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for version changes
        id: version_check
        run: |
          cd clients/python
          VERSION=$(python3 - <<'PY'
          import pathlib, re, sys
          text = pathlib.Path("pyproject.toml").read_text()
          match = re.search(r'^version\s*=\s*"([^"]+)"', text, re.MULTILINE)
          if not match:
              sys.exit("Version not found in pyproject.toml")
          print(match.group(1))
          PY
          )
          echo "current_version=$VERSION" >> "$GITHUB_OUTPUT"
          if git tag | grep -q "python-client-v$VERSION"; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "Version $VERSION already released"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "New version $VERSION detected"
          fi

      - name: Setup Python
        if: steps.version_check.outputs.has_changes == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: steps.version_check.outputs.has_changes == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -e "clients/python[dev]" build twine

      - name: Build distribution
        if: steps.version_check.outputs.has_changes == 'true'
        run: |
          cd clients/python
          python -m build

      - name: Publish to PyPI
        if: steps.version_check.outputs.has_changes == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: clients/python/dist
        env:
          PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}

      - name: Create Git Tag
        if: steps.version_check.outputs.has_changes == 'true'
        run: |
          VERSION=${{ steps.version_check.outputs.current_version }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "python-client-v$VERSION" -m "python client release v$VERSION"
          git push origin "python-client-v$VERSION"

      - name: Create GitHub Release
        if: steps.version_check.outputs.has_changes == 'true'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: python-client-v${{ steps.version_check.outputs.current_version }}
          release_name: Python Client v${{ steps.version_check.outputs.current_version }}
          body: |
            Python client release v${{ steps.version_check.outputs.current_version }}

            Install via pip:
            ```bash
            pip install fluxiondb-client==${{ steps.version_check.outputs.current_version }}
            ```
          draft: false
          prerelease: false
